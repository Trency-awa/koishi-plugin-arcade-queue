# Koishi 机厅排队管理插件（QQ 群版）

基于 DeepSeek 制作的一个专为 QQ 群设计的机厅排队管理系统，支持多群聊隔离、别名查询、数据绑定和权限管理。

## 🎯 功能特性

### 核心功能

- **QQ 群数据隔离**：每个 QQ 群数据完全独立
- **智能别名系统**：支持为机厅设置多个别名，如 `wd`、`hz`、`nb`
- **j 后缀查询**：`wdj` 查询所有别名包含 `wd` 的机厅
- **QQ 群数据绑定**：可以单向绑定其他 QQ 群的机厅数据
- **自动清零**：每天凌晨 4 点自动清零所有机厅排队人数
- **权限管理**：重置功能仅限群主和管理员使用

### 数据管理

- **完整 CRUD**：添加、查询、更新、删除机厅
- **别名管理**：支持多个别名，方便查询
- **历史记录**：保存所有更新记录
- **统计报告**：生成详细的统计数据
- **数据绑定**：单向同步其他 QQ 群数据

## 📦 安装

```bash
# 通过 npm 安装
npm install koishi-plugin-arcade-queue

# 或使用 Koishi 控制台安装
# 在插件市场搜索 "arcade-queue"
```

## ⚙️ 配置

在 Koishi 配置文件 `koishi.yml` 中添加：

```yaml
plugins:
  arcade-queue:
    autoResetTime: "04:00" # 自动清零时间（凌晨4点）
    resetUpdater: "自动清零" # 清零更新者名称
    requireConfirmation: true # 删除操作需要确认
    enableCommands: true # 启用聊天命令
    maxAliasesPerArcade: 5 # 每个机厅最大别名数量
    adminRoles: ["admin", "owner"] # 管理员角色（QQ群群主和管理员）
    resetConfirmationText: "确认重置所有数据" # 重置确认文本
```

## 🚀 使用方法

### 基础命令

```bash
# 添加机厅（支持别名）
机厅添加 迪卡丘牡丹佳和城店 -a dkq,jh

# 查询机厅（支持多种方式）
机厅查询 迪卡丘牡丹佳和城店  # 按名称查询
机厅查询 dkq,jh                    # 按别名查询
机厅查询 dkqj                   # 查询所有dkq,jh别名的机厅

# 更新排队人数
机厅更新 dkq 16

# 列出所有机厅
机厅列表

# 生成统计报告
机厅报告

# 查看系统状态
机厅状态
```

### 高级功能

```bash
# 绑定其他QQ群数据（需要管理员权限）
# QQ群ID格式：平台:群号，如 onebot:123456789
机厅绑定 onebot:123456789 -e

# 重置本群数据（需要管理员权限和二次确认）
机厅重置 "确认重置所有数据"

# 查看帮助
机厅帮助
```

## 🔗 数据绑定说明

### 单向数据流

- A 群绑定 B 群 → A 群可以读取 B 群的机厅数据
- A 群更新数据 → 在 A 群创建本地副本，不影响 B 群
- B 群更新数据 → A 群读取时显示 B 群的最新数据
- 更新记录显示实际更新者和来源 QQ 群

### 使用示例

1. **主群管理**：主群（QQ 群 A）管理所有机厅数据
2. **分群同步**：分群（QQ 群 B）绑定主群，获得只读副本
3. **独立更新**：分群可以独立更新自己的数据副本

## 🔐 权限系统

### 管理员权限

默认管理员角色为 `admin`（群管理员）和 `owner`（群主）

### 受保护的操作

- 重置群聊数据（需要输入确认文本）
- 绑定其他 QQ 群数据
- 清除所有数据

## 📊 数据示例

### 添加示例数据

```bash
机厅添加 迪卡丘牡丹佳和城店 -a dkq,jh
机厅添加 积木熊牡丹万达店 -a jmx,wd
```

### 查询示例

```bash
机厅查询 wdj
# 输出：
# 🔍 查询关键词: "wd" (wdj)
# 📋 找到 1 个机厅:
#
# 1. 积木熊牡丹万达店
#    别名: jmx,wd
#    当前 0 人
#    由 系统 更新于 2025-12-05 00:00:00

机厅列表
# 输出：
# 📋 所有机厅 (共 3 个):
#
# 1. 迪卡丘牡丹佳和城店
#    别名: dkq,jh
#    当前 0 人
#    最后更新: 2025-12-05 00:00:00
#
# 2. 积木熊牡丹万达店
#    别名: jmx,wd
#    当前 0 人
#    最后更新: 2025-12-05 00:00:00
#
```

## 🛠️ 开发说明

### 项目结构

```
src/
├── index.ts      # 插件主入口
├── model.ts      # 数据模型和配置
├── service.ts    # 核心服务逻辑
├── commands.ts   # 聊天命令定义
└── types.ts      # TypeScript 类型定义
```

### 本地开发

```bash
# 克隆项目
git clone <repository-url>

# 安装依赖
npm install

# 构建插件
npm run build

# 开发模式（监听文件变化）
npm run dev
```

## ❓ 常见问题

### Q: 如何获取 QQ 群 ID？

A: QQ 群 ID 格式为 `平台:群号`。使用 OneBot 协议时通常是 `onebot:123456789`。

### Q: 数据绑定是双向的吗？

A: 不是，数据绑定是单向的。绑定群可以读取源群数据，但更新操作只在本地生效。

### Q: 自动清零会影响绑定数据吗？

A: 自动清零只影响本群数据，不会影响绑定的源群数据。

### Q: 如何备份数据？

A: 建议定期备份数据库，或使用数据库自带的备份功能。

## 📝 更新日志

### v2.0.0

- 重构为完整的 QQ 群机厅管理系统
- 添加多 QQ 群隔离支持
- 实现 QQ 群数据绑定功能
- 完善权限管理系统
- 支持 j 后缀智能查询

### v1.0.0

- 基础机厅管理功能
- 别名查询系统
- 自动清零功能

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！
