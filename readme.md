# Koishi 机厅排队管理插件（QQ 群版）v2.1

![Koishi](https://img.shields.io/badge/Koishi-4.x-blue)
![TypeScript](https://img.shields.io/badge/TypeScript-5.x-blue)
![License](https://img.shields.io/badge/License-MIT-green)

基于 DeepSeek 制作的一个专为 QQ 群设计的机厅排队管理系统，支持多群聊隔离、别名查询、数据绑定、白名单管理和权限控制。

## 🎯 核心功能概览

### 权限管理系统

- **智能权限控制**：根据白名单开关状态动态调整权限规则
- **白名单管理**：基于 QQ 号的群独立白名单系统
- **操作分类明确**：将操作分为权限操作和自由操作两类

### 机厅管理功能

- **QQ 群数据隔离**：每个 QQ 群数据完全独立
- **智能别名系统**：支持为机厅设置多个别名，如 `wd`、`hz`、`nb`
- **j 后缀查询**：`wdj` 查询所有别名包含 `wd` 的机厅
- **QQ 群数据绑定**：可以单向绑定其他 QQ 群的机厅数据
- **自动清零**：每天指定时间自动清零所有机厅排队人数

### 群聊绑定系统

- **双向绑定管理**：绑定和解绑群聊数据
- **自动清理**：解绑时自动删除绑定数据
- **单向数据流**：绑定群可读取源群数据，但更新操作只在本地生效

## 📦 安装方式

### 方式一：通过 npm 安装

```bash
npm install koishi-plugin-arcade-queue
```

### 方式二：使用 Koishi 控制台

在插件市场搜索 "arcade-queue" 并安装

## ⚙️ 配置说明

在 Koishi 配置文件 `koishi.yml` 中添加：

```yaml
plugins:
  arcade-queue:
    # 基础配置
    autoResetTime: "04:00" # 自动清零时间（凌晨4点）
    resetUpdater: "自动清零" # 清零更新者名称
    requireConfirmation: true # 删除操作需要确认（防止误操作）
    enableCommands: true # 启用聊天命令

    # 机厅配置
    maxAliasesPerArcade: 5 # 每个机厅最大别名数量

    # 权限配置
    adminRoles: ["admin", "owner"] # 管理员角色（QQ群群主和管理员）
    resetConfirmationText: "确认重置所有数据" # 重置确认文本

    # 白名单配置（新增）
    enableWhiteList: false # 启用白名单功能
    whiteListRequireAdmin: true # 白名单管理需要管理员权限
```

## 🔐 权限系统详解

### 操作分类说明

#### A 类操作：**无需权限，任何人都可以执行**

- ✅ 更新机厅人数
- ✅ 查询机厅信息（按名称、别名、j 后缀）
- ✅ 列出所有机厅
- ✅ 生成统计报告
- ✅ 查看系统状态

#### B 类操作：**需要权限，受白名单控制**

- ✅ 添加机厅
- ✅ 绑定/解绑群聊
- ✅ 重置群聊数据
- ✅ 管理白名单

### 权限规则

#### 情况一：白名单关闭时

```
┌───────────────┐
│  权限持有者    │     可执行的操作
├───────────────┼─────────────────────────►
│   群主(owner)  ├───► 所有B类操作
├───────────────┤
│ 管理员(admin)  ├───► 所有B类操作
├───────────────┤
│   普通用户     ├───► 仅A类操作
└───────────────┘
```

#### 情况二：白名单开启时

```
┌───────────────┐
│  权限持有者    │     可执行的操作
├───────────────┼─────────────────────────►
│   群主(owner)  ├───► 所有B类操作
├───────────────┤
│  白名单成员    ├───► 所有B类操作
├───────────────┤
│ 管理员(admin)  ├───► 仅A类操作（需加入白名单才可执行B类操作）
├───────────────┤
│   普通用户     ├───► 仅A类操作
└───────────────┘
```

## 🚀 快速开始

### 基础命令示例

```bash
# 添加机厅（需要权限）
机厅添加 迪卡丘牡丹佳和城店 -a dkq,jh

# 查询机厅（无需权限）
机厅查询 dkq
机厅查询 dkqj

# 更新排队人数（无需权限）
机厅更新 dkq 16

# 列出所有机厅（无需权限）
机厅列表
```

### 高级功能示例

```bash
# 绑定其他QQ群（需要权限）
机厅绑定 onebot:123456789 -e

# 解绑群聊（需要权限）
机厅解绑

# 重置数据（需要权限）
机厅重置 "确认重置所有数据"

# 白名单管理（需要权限）
机厅白名单添加 @用户
机厅白名单列表
```

## 🔗 数据绑定与解绑

### 绑定功能

- **单向绑定**：可以绑定到其他 QQ 群的机厅数据
- **实时同步**：读取时显示源群的最新数据
- **本地副本**：更新时创建本地副本，不影响源群

### 解绑功能

- **自动清理**：解绑时自动删除通过绑定添加的机厅
- **数据保留**：保留本地创建的机厅
- **权限检查**：需要相应权限才能解绑

### 使用场景

1. **主群管理**：主群维护所有机厅数据
2. **分群绑定**：分群绑定到主群，获得实时数据
3. **独立操作**：分群可独立更新自己的副本
4. **灵活解绑**：随时解绑并清理绑定数据

## 📊 数据管理

### 机厅数据

- **完整信息**：名称、别名、当前人数、平均人数、更新记录
- **历史记录**：保存每次更新的人员和时间
- **统计报告**：生成详细的统计数据和分析

### 白名单数据

- **基于 QQ 号**：存储用户 ID（平台:用户 ID）
- **群组独立**：每个群有自己的白名单
- **完整记录**：记录添加者、添加时间等信息

### 绑定数据

- **关系存储**：记录源群和目标群的绑定关系
- **状态管理**：记录绑定是否启用
- **时间戳**：记录创建和更新时间

## 🛠️ 命令详解

### 查询类命令（A 类，无需权限）

| 命令            | 别名       | 参数         | 说明                                     |
| --------------- | ---------- | ------------ | ---------------------------------------- |
| `arcade.query`  | `机厅查询` | `<查询内容>` | 查询机厅信息，支持名称、别名、j 后缀查询 |
| `arcade.list`   | `机厅列表` | 无           | 列出所有机厅（包括绑定数据）             |
| `arcade.report` | `机厅报告` | 无           | 生成统计报告                             |
| `arcade.status` | `机厅状态` | 无           | 查看系统状态和配置                       |

### 操作类命令

#### 无需权限（A 类）

| 命令            | 别名       | 参数            | 说明             |
| --------------- | ---------- | --------------- | ---------------- |
| `arcade.update` | `机厅更新` | `<查询> <人数>` | 更新机厅排队人数 |

#### 需要权限（B 类）

| 命令            | 别名       | 参数               | 说明               |
| --------------- | ---------- | ------------------ | ------------------ |
| `arcade.add`    | `机厅添加` | `<名称> [-a 别名]` | 添加机厅，支持别名 |
| `arcade.bind`   | `机厅绑定` | `<源群ID> [-e]`    | 绑定到其他 QQ 群   |
| `arcade.unbind` | `机厅解绑` | 无                 | 解绑当前群聊       |
| `arcade.reset`  | `机厅重置` | `<确认文本>`       | 重置本群所有数据   |

### 白名单命令（B 类，需要权限）

| 命令                      | 别名             | 参数               | 说明             |
| ------------------------- | ---------------- | ------------------ | ---------------- |
| `arcade.whitelist.add`    | `机厅白名单添加` | `<用户> [-n 名称]` | 添加用户到白名单 |
| `arcade.whitelist.remove` | `机厅白名单移除` | `<用户>`           | 从白名单移除用户 |
| `arcade.whitelist.list`   | `机厅白名单列表` | 无                 | 查看本群白名单   |
| `arcade.whitelist.clear`  | `机厅白名单清空` | 无                 | 清空白名单       |
| `arcade.whitelist.status` | `机厅白名单状态` | 无                 | 查看白名单状态   |

## 💡 使用技巧

### 别名查询技巧

1. **精确查询**：`机厅查询 dkq` - 按别名查询
2. **j 后缀查询**：`机厅查询 dkqj` - 查询所有包含 dkq 别名的机厅
3. **模糊查询**：直接输入部分名称或别名

### 权限管理技巧

1. **白名单关闭**：适合小规模团队，由管理员统一管理
2. **白名单开启**：适合大规模团队，授权特定成员管理
3. **混合使用**：根据实际需求灵活切换

### 数据绑定技巧

1. **主从架构**：一个主群管理数据，多个分群绑定使用
2. **临时绑定**：需要时绑定，完成后解绑清理
3. **数据隔离**：绑定群可以独立更新不影响源群

## 🔧 开发与定制

### 项目结构

```
src/
├── index.ts          # 插件主入口
├── model.ts          # 数据模型和配置定义
├── service.ts        # 核心服务逻辑
├── commands.ts       # 聊天命令定义
└── types.d.ts        # TypeScript 类型声明
```

### 扩展建议

1. **添加新命令**：在 `commands.ts` 中定义新命令
2. **修改权限**：调整 `service.ts` 中的权限检查逻辑
3. **扩展数据**：在 `model.ts` 中添加新字段和配置
4. **定制输出**：修改服务层中的格式化方法

### 调试技巧

1. **查看日志**：插件启动和操作都有详细日志
2. **权限调试**：使用 `机厅状态` 查看当前权限配置
3. **数据检查**：使用数据库工具直接查看表数据

## ⚠️ 注意事项

### 数据安全

1. **重置确认**：重置操作需要输入确认文本，防止误操作
2. **权限检查**：所有 B 类操作都有严格的权限检查
3. **数据备份**：建议定期备份重要数据

### 性能考虑

1. **定时任务**：自动清零使用定时器，避免频繁数据库操作
2. **查询优化**：使用索引和缓存提高查询效率
3. **内存管理**：及时清理定时器和临时数据

### 兼容性

1. **平台支持**：支持所有 Koishi 兼容的 QQ 平台
2. **版本要求**：需要 Koishi 4.14.0 或更高版本
3. **数据库**：支持所有 Koishi 兼容的数据库

## 🔄 更新维护

### 版本升级

1. **备份数据**：升级前备份数据库
2. **检查配置**：查看新版本配置项变化
3. **测试功能**：在生产环境前充分测试

### 问题排查

1. **权限问题**：检查用户角色和白名单状态
2. **数据异常**：检查数据库表结构和数据完整性
3. **命令无效**：检查插件是否正常加载和配置

## 📝 更新日志

### v2.1.0

- **新增**：完整的白名单管理系统
- **新增**：群聊解绑功能及自动数据清理
- **优化**：权限系统重构，操作分类更清晰
- **改进**：命令输出格式和用户体验
- **修复**：已知问题和性能优化

### v2.0.0

- **重构**：完整的 QQ 群机厅管理系统
- **新增**：多群聊数据隔离和绑定功能
- **完善**：权限管理和安全控制
- **增强**：查询功能和统计报告

### v1.0.0

- **基础功能**：机厅添加、查询、更新
- **别名系统**：智能别名查询
- **自动清零**：定时重置排队人数

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！
